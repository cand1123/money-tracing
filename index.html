<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CanTrack</title>
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="img.png">
    <link rel="shortcut icon" type="image/png" href="img.png">
    <link rel="apple-touch-icon" href="img.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CanTrack">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCPDG5LJ5D8jABjkup3_kEYE3WyPlrlBrA",
            authDomain: "literasi-keuangan.firebaseapp.com",
            databaseURL: "https://literasi-keuangan-default-rtdb.firebaseio.com",
            projectId: "literasi-keuangan",
            storageBucket: "literasi-keuangan.firebasestorage.app",
            messagingSenderId: "15397896464",
            appId: "1:15397896464:web:d9e7ad3be6ed741a8ea595",
            measurementId: "G-60LYG41WR2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseGoogleProvider = googleProvider;
        window.firebaseDatabase = database;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
    </script>
    <style>
        body { overscroll-behavior-y: contain; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-tab { color: #60a5fa; }
        .inactive-tab { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 h-screen flex justify-center text-gray-100">

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-md bg-gray-800 h-full flex flex-col shadow-2xl relative overflow-hidden">
        <div class="flex-1 flex items-center justify-center px-6">
            <div class="w-full text-center space-y-6">
                <div class="space-y-3">
                    <div class="w-20 h-20 mx-auto flex items-center justify-center shadow-lg">
                        <img src="img.png" alt="CanTrack Logo" class="w-20 h-20 rounded-full object-cover">
                    </div>
                    <h1 class="text-xl font-bold text-gray-100">CanTrack</h1>
                    <p class="text-gray-300 text-xs">Kelola keuangan Anda dengan mudah dan aman</p>
                </div>
                
                <div class="pt-4">
                    <!-- Firebase Google Sign-In Button -->
                    <button onclick="handleGoogleLogin()" class="w-full bg-gray-700 border-2 border-gray-600 rounded-md px-4 py-3 flex items-center justify-center gap-3 hover:bg-gray-600 shadow-sm">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span class="text-gray-300 font-semibold text-xs">Masuk dengan Google</span>
                    </button>
                </div>
                
                <p class="text-[10px] text-gray-400 pt-4">
                    Dengan masuk, Anda menyetujui<br>
                    <span class="text-blue-400">Ketentuan Layanan</span> dan 
                    <span class="text-blue-400">Kebijakan Privasi</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden w-full max-w-md bg-gray-800 h-full flex flex-col shadow-2xl relative overflow-hidden">

        <header class="bg-gray-800 px-5 py-4 flex justify-between items-center shadow-sm shadow-gray-900/50 z-20 border-b border-gray-700">
            <div class="flex items-center gap-2">
                <img src="img.png" alt="CanTrack" class="w-8 h-8 rounded-full object-cover">
                <h1 class="font-bold text-base text-gray-100">CanTrack</h1>
            </div>
            <div class="flex gap-2">
                <div onclick="handleLogout()" class="w-8 h-8 bg-blue-900/30 rounded-full flex items-center justify-center text-blue-400 cursor-pointer active:scale-90 transition" title="Keluar">
                    <i class="fa-solid fa-sign-out-alt text-sm"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-16 px-4 pt-4 no-scrollbar" id="main-container">
            
            <div id="view-home" class="fade-in space-y-5">
                <div class="bg-gray-800 rounded-lg p-5 text-gray-100 shadow-2xl relative overflow-hidden border border-gray-700/50 backdrop-blur-sm">
                    <!-- Decorative Elements -->
                    <div class="absolute -right-12 -bottom-12 w-48 h-48 bg-blue-500/10 rounded-full blur-3xl"></div>
                    <div class="absolute -left-8 top-0 w-32 h-32 bg-indigo-500/10 rounded-full blur-2xl"></div>
                    <div class="absolute top-0 right-0 w-24 h-24 bg-blue-400/10 rounded-full blur-xl"></div>
                    
                    <!-- Header with Toggle Button -->
                    <div class="relative z-10 flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-gray-700/50 backdrop-blur-md rounded-lg flex items-center justify-center border border-gray-600/50 overflow-hidden">
                                <img src="img.png" alt="CanTrack" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-300 font-medium">Total Saldo</p>
                                <p class="text-[9px] text-gray-300">Semua Bank</p>
                            </div>
                        </div>
                        <button onclick="toggleBalanceVisibility()" id="balance-toggle-btn" class="flex items-center justify-center transition-all duration-200 active:scale-95" title="Sembunyikan/Tampilkan Saldo">
                            <i id="balance-toggle-icon" class="fa-solid fa-eye text-xs text-gray-300"></i>
                        </button>
                    </div>
                    
                    <!-- Balance Display -->
                    <div class="relative z-10 mb-5">
                        <div id="balance-visible-container" class="mb-1">
                            <div id="dashboard-total-balance" class="text-2xl font-extrabold tracking-tight drop-shadow-lg">Rp 0</div>
                        </div>
                        <div id="balance-hidden" class="hidden mb-1">
                            <span class="text-2xl font-extrabold tracking-tight text-gray-300/90 drop-shadow-lg">••••••••</span>
                        </div>
                    </div>
                    
                    <!-- Income & Expense Cards -->
                    <div class="relative z-10 flex gap-3">
                        <div class="flex-1 bg-gray-700/50 backdrop-blur-md px-4 py-3.5 rounded-lg border border-gray-600/50 shadow-lg hover:bg-gray-700/70 transition-all duration-200">
                            <div class="flex items-center gap-2 mb-1.5">
                                <div class="w-6 h-6 bg-green-500/30 rounded-full flex items-center justify-center">
                                    <i class="fa-solid fa-arrow-down text-green-400 text-[10px]"></i>
                                </div>
                                <p class="text-[9px] text-gray-300 font-semibold uppercase tracking-wide">Masuk</p>
                            </div>
                            <p class="text-sm font-bold mb-0.5 text-gray-100" id="dashboard-income">Rp 0</p>
                            <p class="text-[8px] text-gray-300">Bulan Ini</p>
                        </div>
                        <div class="flex-1 bg-gray-700/50 backdrop-blur-md px-4 py-3.5 rounded-lg border border-gray-600/50 shadow-lg hover:bg-gray-700/70 transition-all duration-200">
                            <div class="flex items-center gap-2 mb-1.5">
                                <div class="w-6 h-6 bg-red-500/30 rounded-full flex items-center justify-center">
                                    <i class="fa-solid fa-arrow-up text-red-400 text-[10px]"></i>
                                </div>
                                <p class="text-[9px] text-gray-300 font-semibold uppercase tracking-wide">Keluar</p>
                            </div>
                            <p class="text-sm font-bold mb-0.5 text-gray-100" id="dashboard-expense">Rp 0</p>
                            <p class="text-[8px] text-gray-300">Bulan Ini</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-sm text-gray-200">Dompet Bank</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-3" id="bank-list-container">
                        </div>
                </div>

                <div>
                    <h3 class="font-bold text-sm text-gray-200 mb-3">Transaksi Terakhir</h3>
                    <div class="space-y-3" id="recent-transaction-list">
                        <div class="text-center py-4 text-gray-400 text-xs">Belum ada transaksi</div>
                    </div>
                </div>
            </div>

            <div id="view-input" class="hidden fade-in h-full">
                <h2 class="text-lg font-bold text-gray-100 mb-6 text-center">Tambah Transaksi</h2>
                
                <div class="bg-gray-700 p-1 rounded-md flex mb-6">
                    <button id="btn-expense" onclick="setTxType('expense')" class="flex-1 py-2 rounded text-xs font-bold bg-gray-800 text-red-400 shadow-sm transition">Pengeluaran</button>
                    <button id="btn-income" onclick="setTxType('income')" class="flex-1 py-2 rounded text-xs font-bold text-gray-300 transition">Pemasukan</button>
                </div>

                <form onsubmit="handleSaveTransaction(event)">
                    <div class="mb-6">
                        <label class="block text-xs text-gray-300 mb-1 font-semibold text-center uppercase tracking-wide">Nominal</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-300 font-bold">Rp</span>
                            <input type="text" id="input-nominal" required oninput="formatNominalInput(this)" autocomplete="off" class="w-full bg-gray-700 text-center text-2xl font-bold text-gray-100 py-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="0">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs text-gray-300 mb-2 font-semibold">Pilih Akun Bank</label>
                        <div id="input-bank-container" class="grid grid-cols-2 gap-2">
                            </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs text-gray-300 mb-1 font-semibold">Kategori</label>
                        <select id="input-category" required class="w-full bg-gray-700 text-gray-100 p-4 rounded-md border border-gray-600 text-xs font-semibold appearance-none focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs text-gray-300 mb-1 font-semibold">Catatan</label>
                        <input type="text" id="input-note" required autocomplete="off" class="w-full bg-gray-700 text-gray-100 p-4 rounded-md border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Makan, Bensin, Gaji...">
                    </div>

                    <div class="mb-8">
                        <label class="block text-xs text-gray-300 mb-1 font-semibold">Tanggal</label>
                        <input type="date" id="input-date" required autocomplete="off" class="w-full bg-gray-700 text-gray-100 p-4 rounded-md border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>

                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-4 rounded-md shadow-lg active:scale-95 transition">Simpan Data</button>
                    <button type="button" onclick="switchTab('home')" class="w-full text-gray-400 font-semibold py-4 text-xs mt-2">Batal</button>
                </form>
            </div>

            <div id="view-history" class="hidden fade-in pb-14">
                <h2 class="text-lg font-bold text-gray-100 mb-4">Semua Riwayat</h2>
                
                <div class="bg-gray-700 p-4 rounded-md border border-gray-600 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-xs font-semibold text-gray-300">Filter</label>
                        <button onclick="resetDateFilter()" class="text-xs text-blue-400 hover:underline">Reset</button>
                    </div>
                    <div class="mb-3">
                        <label class="block text-[10px] text-gray-300 mb-1">Tipe Transaksi</label>
                        <select id="filter-type" onchange="applyDateFilter()" class="w-full bg-gray-800 p-2 rounded border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="">Semua</option>
                            <option value="income">Pemasukan</option>
                            <option value="expense">Pengeluaran</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-gray-300 mb-1">Dari Tanggal</label>
                            <input type="date" id="filter-date-from" onchange="applyDateFilter()" autocomplete="off" class="w-full bg-gray-800 p-2 rounded border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-300 mb-1">Sampai Tanggal</label>
                            <input type="date" id="filter-date-to" onchange="applyDateFilter()" autocomplete="off" class="w-full bg-gray-800 p-2 rounded border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3" id="full-history-list">
                     </div>
            </div>

            <div id="view-stats" class="hidden fade-in pb-14">
                <h2 class="text-lg font-bold text-gray-100 mb-4">Statistik Keuangan</h2>
                
                <div class="space-y-4">
                    <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                        <h3 class="text-xs font-semibold text-gray-300 mb-3">Ringkasan Bulan Ini</h3>
                        <div class="space-y-3">
                            <div class="bg-blue-50 bg-blue-900/20 p-3 rounded-lg border border-blue-800 mb-3">
                                <div id="stats-total-balance-container" class="flex justify-between items-center">
                                    <span class="text-[10px] font-semibold text-gray-300">Total Saldo</span>
                                    <span id="stats-total-balance" class="text-sm font-bold text-blue-400">Rp 0</span>
                                </div>
                                <div id="stats-total-balance-hidden" class="hidden flex justify-between items-center">
                                    <span class="text-[10px] font-semibold text-gray-300">Total Saldo</span>
                                    <span class="text-sm font-bold text-blue-400">••••••</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-gray-300">Total Pemasukan</span>
                                <div class="flex items-center gap-2">
                                    <span id="stats-monthly-income" class="text-xs font-bold text-green-400">Rp 0</span>
                                    <span id="stats-income-percentage" class="text-[9px] font-semibold text-green-400">(9%)</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-gray-300">Total Pengeluaran</span>
                                <div class="flex items-center gap-2">
                                    <span id="stats-monthly-expense" class="text-xs font-bold text-red-400">Rp 0</span>
                                    <span id="stats-expense-percentage" class="text-[9px] font-semibold text-red-400">(0%)</span>
                                </div>
                            </div>
                            <div class="border-t border-gray-600 pt-3 mt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-semibold text-gray-300">Saldo Bersih</span>
                                    <span id="stats-monthly-net" class="text-sm font-bold text-blue-400">Rp 0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                        <h3 class="text-xs font-semibold text-gray-300 mb-3">Statistik Per Bank</h3>
                        <div class="space-y-3" id="stats-bank-list">
                        </div>
                    </div>

                    <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                        <h3 class="text-xs font-semibold text-gray-300 mb-3">Top 5 Transaksi Terbesar</h3>
                        <div class="space-y-2" id="stats-top-transactions">
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-profile" class="hidden fade-in pb-14">
                <h2 class="text-lg font-bold text-gray-100 mb-4">Pengaturan</h2>
                
                <div class="space-y-4">
                    <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                        <h3 class="text-xs font-semibold text-gray-300 mb-3">Informasi Aplikasi</h3>
                        <div class="space-y-2 text-[10px]">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Versi</span>
                                <span class="font-semibold text-gray-200">v1.0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Total Transaksi</span>
                                <span class="font-semibold text-gray-200" id="profile-total-transactions">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Total Bank</span>
                                <span class="font-semibold text-gray-200" id="profile-total-banks">4</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                        <h3 class="text-xs font-semibold text-gray-300 mb-3">Informasi Rekening</h3>
                        <div class="space-y-2 mb-3" id="account-numbers-list">
                        </div>
                    </div>

                    <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                        <h3 class="text-xs font-semibold text-gray-300 mb-3">Kelola Akun Bank</h3>
                        <div class="space-y-2 mb-3" id="bank-management-list">
                        </div>
                        <button onclick="openAddBankModal()" class="w-full bg-green-500 text-white text-xs font-semibold py-2 rounded active:scale-95 transition">
                            <i class="fa-solid fa-plus mr-2"></i>Tambah Bank Baru
                        </button>
                    </div>

                    <div class="bg-gray-700 p-4 rounded-md border border-gray-600">
                        <h3 class="text-xs font-semibold text-gray-300 mb-3">Tentang</h3>
                        <p class="text-[10px] text-gray-300 leading-relaxed">
                            CanTrack adalah aplikasi pencatatan keuangan sederhana untuk membantu Anda mengelola keuangan pribadi dengan mudah dan efisien.
                        </p>
                    </div>
                     </div>
            </div>

        </main>

        <!-- Modal Edit/Tambah Bank -->
        <div id="bank-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeBankModal()">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-bold text-gray-100" id="bank-modal-title">Edit Bank</h3>
                    <button onclick="closeBankModal()" class="text-gray-300 hover:text-gray-200">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <form onsubmit="handleSaveBank(event)" id="bank-form">
                    <input type="hidden" id="edit-bank-id">
                    <div class="mb-4">
                        <label class="block text-xs text-gray-300 mb-1 font-semibold">Nama Bank</label>
                        <input type="text" id="edit-bank-name" required autocomplete="off" class="w-full bg-gray-700 text-gray-100 p-3 rounded border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs text-gray-300 mb-1 font-semibold">Nomor Rekening</label>
                        <input type="text" id="edit-bank-account" autocomplete="off" class="w-full bg-gray-700 text-gray-100 p-3 rounded border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Contoh: 1234567890">
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs text-gray-300 mb-1 font-semibold">Warna</label>
                        <select id="edit-bank-color" class="w-full bg-gray-700 text-gray-100 p-3 rounded border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="text-blue-600">Biru</option>
                            <option value="text-yellow-500">Kuning</option>
                            <option value="text-orange-500">Orange</option>
                            <option value="text-green-600">Hijau</option>
                            <option value="text-red-500">Merah</option>
                            <option value="text-purple-500">Ungu</option>
                            <option value="text-pink-500">Pink</option>
                            <option value="text-indigo-500">Indigo</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs text-gray-300 mb-1 font-semibold">Ikon</label>
                        <select id="edit-bank-icon" class="w-full bg-gray-700 text-gray-100 p-3 rounded border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="fa-building-columns">Bank</option>
                            <option value="fa-wallet">Dompet</option>
                            <option value="fa-money-bill">Uang Tunai</option>
                            <option value="fa-credit-card">Kartu</option>
                            <option value="fa-piggy-bank">Celengan</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-blue-500 text-white text-xs font-semibold py-3 rounded active:scale-95 transition">
                            Simpan
                        </button>
                        <button type="button" onclick="closeBankModal()" class="flex-1 bg-gray-700 text-gray-300 text-xs font-semibold py-3 rounded active:scale-95 transition">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pop-up Modal -->
        <div id="popup-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closePopup()">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm shadow-2xl transform transition-all" onclick="event.stopPropagation()">
                <div class="flex items-center justify-center mb-4">
                    <div id="popup-icon" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl">
                        <i class="fa-solid fa-check-circle text-green-500"></i>
                    </div>
                </div>
                <h3 id="popup-title" class="text-lg font-bold text-gray-100 text-center mb-2">Berhasil</h3>
                <p id="popup-message" class="text-sm text-gray-300 text-center mb-6">Pesan akan muncul di sini</p>
                <div id="popup-buttons" class="flex gap-2">
                    <button id="popup-ok-btn" onclick="closePopup()" class="flex-1 bg-blue-500 text-white text-sm font-semibold py-3 rounded active:scale-95 transition">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeConfirm()">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm shadow-2xl transform transition-all" onclick="event.stopPropagation()">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-16 h-16 rounded-full bg-yellow-900/30 flex items-center justify-center">
                        <i class="fa-solid fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                    </div>
                </div>
                <h3 id="confirm-title" class="text-lg font-bold text-gray-100 text-center mb-2">Konfirmasi</h3>
                <p id="confirm-message" class="text-sm text-gray-300 text-center mb-6">Apakah Anda yakin?</p>
                <div class="flex gap-2">
                    <button id="confirm-cancel-btn" onclick="closeConfirm()" class="flex-1 bg-gray-700 text-gray-300 text-sm font-semibold py-3 rounded active:scale-95 transition">
                        Batal
                    </button>
                    <button id="confirm-ok-btn" onclick="confirmAction()" class="flex-1 bg-blue-500 text-white text-sm font-semibold py-3 rounded active:scale-95 transition">
                        Ya
                    </button>
                </div>
            </div>
        </div>

        <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-30">
            <button onclick="prepareInput()" class="w-16 h-16 bg-blue-500 rounded-full shadow-2xl flex items-center justify-center text-white text-xl active:scale-90 transition border-4 border-gray-800">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <nav class="bg-gray-800 border-t border-gray-700 h-14 px-6 flex justify-between items-start pt-2 z-20">
            <button onclick="switchTab('home')" class="flex flex-col items-center w-12 group">
                <i id="icon-home" class="fa-solid fa-house text-lg mb-1 active-tab"></i>
                <span id="text-home" class="text-[9px] font-medium text-blue-400">Home</span>
            </button>
            <button onclick="switchTab('history')" class="flex flex-col items-center w-12 mr-8 group">
                <i id="icon-history" class="fa-solid fa-clock-rotate-left text-lg mb-1 inactive-tab"></i>
                <span id="text-history" class="text-[9px] font-medium text-gray-300">Riwayat</span>
            </button>
            <div class="w-8"></div>
            <button onclick="switchTab('stats')" class="flex flex-col items-center w-12 ml-8 group">
                <i id="icon-stats" class="fa-solid fa-chart-simple text-lg mb-1 inactive-tab"></i>
                <span id="text-stats" class="text-[9px] font-medium text-gray-300">Rekapan</span>
            </button>
            <button onclick="switchTab('profile')" class="flex flex-col items-center w-12 group">
                <i id="icon-profile" class="fa-solid fa-user text-lg mb-1 inactive-tab"></i>
                <span id="text-profile" class="text-[9px] font-medium text-gray-300">Akun</span>
            </button>
        </nav>

    </div>

    <script>
        // --- 0. POP-UP FUNCTIONS ---
        let confirmCallback = null;

        function showPopup(title, message, type = 'success') {
            const modal = document.getElementById('popup-modal');
            const popupTitle = document.getElementById('popup-title');
            const popupMessage = document.getElementById('popup-message');
            const popupIcon = document.getElementById('popup-icon');
            
            popupTitle.textContent = title;
            popupMessage.textContent = message;
            
            // Set icon based on type
            popupIcon.className = 'w-16 h-16 rounded-full flex items-center justify-center text-2xl';
            if (type === 'success') {
                popupIcon.innerHTML = '<i class="fa-solid fa-check-circle text-green-500"></i>';
                popupIcon.classList.add('bg-green-900/30');
            } else if (type === 'error') {
                popupIcon.innerHTML = '<i class="fa-solid fa-times-circle text-red-500"></i>';
                popupIcon.classList.add('bg-red-900/30');
            } else if (type === 'info') {
                popupIcon.innerHTML = '<i class="fa-solid fa-info-circle text-blue-500"></i>';
                popupIcon.classList.add('bg-blue-900/30');
            } else if (type === 'warning') {
                popupIcon.innerHTML = '<i class="fa-solid fa-exclamation-triangle text-yellow-500"></i>';
                popupIcon.classList.add('bg-yellow-900/30');
            }
            
            modal.classList.remove('hidden');
        }

        function closePopup() {
            const modal = document.getElementById('popup-modal');
            modal.classList.add('hidden');
        }

        function showConfirm(title, message, callback) {
            const modal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            
            modal.classList.remove('hidden');
        }

        function closeConfirm() {
            const modal = document.getElementById('confirm-modal');
            modal.classList.add('hidden');
            confirmCallback = null;
        }

        function confirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirm();
        }

        // --- 1. INISIALISASI DATA & STATE ---
        let defaultBanks = [];
        let categories = { income: [], expense: [] };
        let banks = [];
        let transactions = [];
        let currentTxType = 'expense';
        let selectedBankId = null;
        let balanceVisible = localStorage.getItem('sb_balanceVisible') !== 'false'; // Default true
        let user = JSON.parse(localStorage.getItem('sb_user')) || null;

        // Load configuration from JSON file
        async function loadConfig() {
            try {
                const response = await fetch('config.json');
                if (!response.ok) throw new Error('Config file not found');
                
                const config = await response.json();
                defaultBanks = config.defaultBanks || [];
                categories = config.categories || { income: [], expense: [] };
            } catch (error) {
                console.error('Error loading config:', error);
                // Fallback to hardcoded defaults
                defaultBanks = [
                    { id: 'bca', name: 'BCA', balance: 0, color: 'text-blue-600', icon: 'fa-building-columns', accountNumber: '' },
                    { id: 'mandiri', name: 'Mandiri', balance: 0, color: 'text-yellow-500', icon: 'fa-building-columns', accountNumber: '' },
                    { id: 'jago', name: 'Jago', balance: 0, color: 'text-orange-500', icon: 'fa-wallet', accountNumber: '' },
                    { id: 'cash', name: 'Tunai', balance: 0, color: 'text-green-600', icon: 'fa-money-bill', accountNumber: '' }
                ];
                categories = {
                    income: [
                        { id: 'gaji', name: 'Gaji' },
                        { id: 'bonus', name: 'Bonus/Komisi' },
                        { id: 'usaha', name: 'Usaha/Sampingan' },
                        { id: 'transfer-masuk', name: 'Transfer Masuk' }
                    ],
                    expense: [
                        { id: 'makanan', name: 'Makanan & Minuman' },
                        { id: 'transportasi', name: 'Transportasi' },
                        { id: 'tagihan', name: 'Tagihan Rutin' },
                        { id: 'belanja', name: 'Belanja Harian' },
                        { id: 'kesehatan', name: 'Kesehatan' },
                        { id: 'cicilan', name: 'Cicilan' },
                        { id: 'rumah-tangga', name: 'Kebutuhan Rumah Tangga' }
                    ]
                };
            }
            
            // Initialize banks and transactions from localStorage or defaults
            banks = JSON.parse(localStorage.getItem('sb_banks')) || defaultBanks;
            transactions = JSON.parse(localStorage.getItem('sb_transactions')) || [];
        }

        // Helper function to convert Firebase object to array
        function firebaseObjectToArray(obj) {
            if (!obj) return [];
            if (Array.isArray(obj)) return obj;
            // If it's an object, convert to array
            return Object.keys(obj).map(key => obj[key]);
        }

        // Load user data from Firebase Realtime Database
        async function loadUserData() {
            if (!user || !user.uid || !window.firebaseDatabase || !window.firebaseRef || !window.firebaseGet) {
                // Fallback to localStorage
                banks = JSON.parse(localStorage.getItem('sb_banks')) || defaultBanks;
                transactions = JSON.parse(localStorage.getItem('sb_transactions')) || [];
                return;
            }

            try {
                const userId = user.uid;
                const banksRef = window.firebaseRef(window.firebaseDatabase, `users/${userId}/banks`);
                const transactionsRef = window.firebaseRef(window.firebaseDatabase, `users/${userId}/transactions`);

                const [banksSnapshot, transactionsSnapshot] = await Promise.all([
                    window.firebaseGet(banksRef),
                    window.firebaseGet(transactionsRef)
                ]);

                if (banksSnapshot.exists()) {
                    const banksData = banksSnapshot.val();
                    banks = firebaseObjectToArray(banksData);
                } else {
                    // If no data in Firebase, use localStorage or defaults
                    banks = JSON.parse(localStorage.getItem('sb_banks')) || defaultBanks;
                    // Save to Firebase for first time
                    if (banks.length > 0) {
                        await window.firebaseSet(banksRef, banks);
                    }
                }

                if (transactionsSnapshot.exists()) {
                    const transactionsData = transactionsSnapshot.val();
                    transactions = firebaseObjectToArray(transactionsData);
                } else {
                    // If no data in Firebase, use localStorage
                    transactions = JSON.parse(localStorage.getItem('sb_transactions')) || [];
                    // Save to Firebase for first time
                    if (transactions.length > 0) {
                        await window.firebaseSet(transactionsRef, transactions);
                    }
                }

                // Ensure arrays are properly formatted
                if (!Array.isArray(banks)) banks = [];
                if (!Array.isArray(transactions)) transactions = [];

                // Update localStorage as backup
                localStorage.setItem('sb_banks', JSON.stringify(banks));
                localStorage.setItem('sb_transactions', JSON.stringify(transactions));
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                // Fallback to localStorage
                banks = JSON.parse(localStorage.getItem('sb_banks')) || defaultBanks;
                transactions = JSON.parse(localStorage.getItem('sb_transactions')) || [];
            }
        }

        // --- 2. FORMATTER HELPERS ---
        const formatRupiah = (num) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        };

        const formatRupiahWithVisibility = (num) => {
            if (balanceVisible) {
                return formatRupiah(num);
            } else {
                return '••••••';
            }
        };

        const formatNominalInput = (input) => {
            // Hapus semua karakter non-digit
            let value = input.value.replace(/\D/g, '');
            
            // Format dengan pemisah ribuan
            if (value) {
                const numValue = parseInt(value);
                if (!isNaN(numValue)) {
                    input.value = numValue.toLocaleString('id-ID');
                } else {
                    input.value = '';
                }
            } else {
                input.value = '';
            }
        };

        const getNumericValue = (formattedValue) => {
            // Ambil nilai angka saja dari string yang sudah diformat
            return parseInt(formattedValue.replace(/\D/g, '')) || 0;
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // --- 3. CORE LOGIC (CRUD) ---
        
        function updateDashboard() {
            // 1. Calculate Total Balance
            let totalBalance = banks.reduce((acc, bank) => acc + bank.balance, 0);
            const balanceElement = document.getElementById('dashboard-total-balance');
            const balanceVisibleContainer = document.getElementById('balance-visible-container');
            const balanceHiddenElement = document.getElementById('balance-hidden');
            
            balanceElement.textContent = formatRupiah(totalBalance);
            
            // Update visibility based on balanceVisible state
            if (balanceVisible) {
                if (balanceVisibleContainer) balanceVisibleContainer.classList.remove('hidden');
                if (balanceHiddenElement) balanceHiddenElement.classList.add('hidden');
            } else {
                if (balanceVisibleContainer) balanceVisibleContainer.classList.add('hidden');
                if (balanceHiddenElement) balanceHiddenElement.classList.remove('hidden');
            }

            // 2. Calculate Monthly Income/Expense
            const currentMonth = moment().format('YYYY-MM');
            let monthlyIncome = 0;
            let monthlyExpense = 0;

            transactions.forEach(tx => {
                if (tx.date.startsWith(currentMonth)) {
                    if (tx.type === 'income') monthlyIncome += tx.nominal;
                    else monthlyExpense += tx.nominal;
                }
            });

            // 3. Display Monthly Income/Expense
            document.getElementById('dashboard-income').textContent = formatRupiahWithVisibility(monthlyIncome);
            document.getElementById('dashboard-expense').textContent = formatRupiahWithVisibility(monthlyExpense);

            // 3. Render Bank Cards
            const bankContainer = document.getElementById('bank-list-container');
            bankContainer.innerHTML = '';
            banks.forEach(bank => {
                bankContainer.innerHTML += `
                    <div class="bg-gray-700 p-3 rounded-md shadow-sm border border-gray-600 flex items-center gap-3 transition-colors duration-200">
                        <i class="fa-solid ${bank.icon} ${bank.color} text-base"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-[10px] text-gray-300 truncate">${bank.name}</p>
                            <p class="font-bold text-gray-100 text-xs">${formatRupiahWithVisibility(bank.balance)}</p>
                        </div>
                    </div>
                `;
            });

            // 4. Render Transactions (Recent & Full)
            renderTransactionList();
        }

        function renderTransactionList(filteredTransactions = null) {
            const recentContainer = document.getElementById('recent-transaction-list');
            const fullContainer = document.getElementById('full-history-list');
            
            // Use filtered transactions if provided, otherwise use all transactions
            let transactionsToRender = filteredTransactions !== null ? filteredTransactions : transactions;
            
            // Sort: Newest First
            transactionsToRender.sort((a, b) => new Date(b.date) - new Date(a.date));

            const generateItemHTML = (tx) => {
                const bank = banks.find(b => b.id === tx.bankId);
                // Filter out transactions with deleted banks
                if (!bank) return '';
                
                const isExpense = tx.type === 'expense';
                const colorClass = isExpense ? 'text-red-500 text-red-400' : 'text-green-600 text-green-400';
                const sign = isExpense ? '-' : '+';
                const iconBg = isExpense ? 'bg-red-900/30' : 'bg-green-900/30';
                const icon = isExpense ? 'fa-arrow-up' : 'fa-arrow-down';
                
                // Get category name
                const categoryList = categories[tx.type] || [];
                const category = categoryList.find(cat => cat.id === tx.category);
                const categoryName = category ? category.name : (tx.category || '-');

                return `
                    <div class="bg-gray-700 p-3 rounded-md shadow-sm shadow-gray-900/50 border border-gray-600 flex items-center justify-between group relative overflow-hidden">
                        <div class="flex items-center gap-3 relative z-10">
                            <div class="w-10 h-10 ${iconBg} rounded-full flex items-center justify-center ${colorClass}">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-xs text-gray-100">${tx.note}</p>
                                <p class="text-[10px] text-gray-400">${categoryName} • ${bank ? bank.name : 'Unknown'} • ${moment(tx.date).format('D MMM YYYY')}</p>
                            </div>
                        </div>
                        <div class="text-right z-10">
                            <span class="${colorClass} font-bold text-xs block">${sign} ${formatRupiahWithVisibility(tx.nominal)}</span>
                            <button onclick="deleteTransaction('${tx.id}')" class="text-[9px] text-gray-400 underline mt-1 hover:text-red-400">Hapus</button>
                        </div>
                    </div>
                `;
            };

            // Filter transactions to only show those with valid banks
            const validTransactions = transactions.filter(tx => banks.find(b => b.id === tx.bankId));
            const validTransactionsToRender = filteredTransactions !== null 
                ? filteredTransactions.filter(tx => banks.find(b => b.id === tx.bankId))
                : validTransactions;
            
            // Render Recent (Top 5) - always use valid transactions
            const recentValid = validTransactions.slice(0, 5);
            recentContainer.innerHTML = recentValid.map(generateItemHTML).filter(html => html !== '').join('') || '<div class="text-center py-4 text-gray-400 text-xs">Belum ada transaksi</div>';
            
            // Render Full - use filtered valid transactions
            fullContainer.innerHTML = validTransactionsToRender.map(generateItemHTML).filter(html => html !== '').join('') || '<div class="text-center py-10 text-gray-400 text-xs">Belum ada transaksi tersimpan</div>';
        }

        async function handleSaveTransaction(e) {
            e.preventDefault();
            
            const nominalInput = document.getElementById('input-nominal').value;
            const nominal = getNumericValue(nominalInput);
            const bankId = selectedBankId;
            const category = document.getElementById('input-category').value;
            const note = document.getElementById('input-note').value;
            const date = document.getElementById('input-date').value;

            if (!nominal || !bankId || !category || !note || !date) {
                showPopup('Peringatan', 'Mohon lengkapi semua data!', 'warning');
                return;
            }

            // 1. Create Transaction Object
            const newTx = {
                id: generateId(),
                type: currentTxType,
                bankId,
                category,
                nominal,
                note,
                date
            };

            // 2. Update Bank Balance
            const bankIndex = banks.findIndex(b => b.id === bankId);
            if (currentTxType === 'income') {
                banks[bankIndex].balance += nominal;
            } else {
                banks[bankIndex].balance -= nominal;
            }

            // 3. Save to Arrays
            transactions.unshift(newTx);
            
            // 4. Persist to Firebase and LocalStorage
            await saveData();

            // 5. Reset UI
            e.target.reset();
            selectedBankId = null;
            document.getElementById('input-date').valueAsDate = new Date(); // Reset date to today
            // Reset bank selection visual
            document.querySelectorAll('.bank-box').forEach(box => {
                box.classList.remove('ring-2', 'ring-blue-400', 'border-blue-400');
                box.classList.add('border-gray-600');
            });
            // Reset category dropdown
            updateCategoryDropdown();
            showPopup('Berhasil', 'Transaksi berhasil disimpan!', 'success');
            switchTab('home');
        }

        async function deleteTransaction(id) {
            showConfirm('Konfirmasi Hapus', 'Yakin ingin menghapus transaksi ini? Saldo akan dikembalikan.', async () => {
                const txIndex = transactions.findIndex(t => t.id === id);
            if (txIndex > -1) {
                const tx = transactions[txIndex];
                
                // Revert Balance
                const bankIndex = banks.findIndex(b => b.id === tx.bankId);
                if (tx.type === 'income') {
                    banks[bankIndex].balance -= tx.nominal; // Undo income
                } else {
                    banks[bankIndex].balance += tx.nominal; // Undo expense
                }

                // Remove Transaction
                transactions.splice(txIndex, 1);
                
                await saveData();
                
                // Re-render with filter if active
                const dateFrom = document.getElementById('filter-date-from').value;
                const dateTo = document.getElementById('filter-date-to').value;
                const typeFilter = document.getElementById('filter-type').value;
                if (dateFrom || dateTo || typeFilter) {
                    applyDateFilter();
                } else {
                    renderTransactionList();
                }
                
                updateDashboard(); // Re-calc totals
            }
            });
        }

        // Fungsi untuk menyimpan data keuangan ke Firebase dan localStorage
        async function saveData() {
            // Simpan ke localStorage sebagai backup
            localStorage.setItem('sb_banks', JSON.stringify(banks));
            localStorage.setItem('sb_transactions', JSON.stringify(transactions));
            
            // Simpan ke Firebase Realtime Database jika user sudah login
            if (user && user.uid && window.firebaseDatabase && window.firebaseRef && window.firebaseSet) {
                try {
                    const userId = user.uid;
                    const userRef = window.firebaseRef(window.firebaseDatabase, `users/${userId}`);
                    
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, `users/${userId}/banks`), banks);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, `users/${userId}/transactions`), transactions);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, `users/${userId}/lastUpdated`), new Date().toISOString());
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                    // Continue even if Firebase save fails, localStorage is already saved
                }
            }
            
            updateDashboard();
        }

        async function resetData() {
            showConfirm('PERINGATAN', 'Ini akan menghapus SEMUA data transaksi dan mereset saldo menjadi 0. Lanjutkan?', async () => {
                // Delete from Firebase
                if (user && user.uid && window.firebaseDatabase && window.firebaseRef && window.firebaseSet) {
                    try {
                        const userId = user.uid;
                        await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, `users/${userId}/banks`), null);
                        await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, `users/${userId}/transactions`), null);
                    } catch (error) {
                        console.error('Error deleting from Firebase:', error);
                    }
                }
                
                localStorage.removeItem('sb_banks');
                localStorage.removeItem('sb_transactions');
                location.reload();
            });
        }

        // --- 4. UI INTERACTION HELPERS ---

        function selectBank(bankId) {
            selectedBankId = bankId;
            // Update visual selection
            document.querySelectorAll('.bank-box').forEach(box => {
                box.classList.remove('ring-2', 'ring-blue-400', 'border-blue-400');
                box.classList.add('border-gray-600');
            });
            const selectedBox = document.querySelector(`[data-bank-id="${bankId}"]`);
            if (selectedBox) {
                selectedBox.classList.add('ring-2', 'ring-blue-400', 'border-blue-400');
                selectedBox.classList.remove('border-gray-600');
            }
        }

        function prepareInput() {
            // Reset selection
            selectedBankId = null;
            
            // Render Bank Boxes
            const container = document.getElementById('input-bank-container');
            container.innerHTML = '';
            banks.forEach(bank => {
                container.innerHTML += `
                    <div onclick="selectBank('${bank.id}')" data-bank-id="${bank.id}" class="bank-box bg-gray-700 p-2 rounded border border-gray-600 cursor-pointer active:scale-95 transition-all duration-200 hover:shadow-sm">
                        <div class="flex items-center gap-2 mb-1">
                            <i class="fa-solid ${bank.icon} ${bank.color} text-xs"></i>
                            <p class="font-bold text-[10px] text-gray-100">${bank.name}</p>
                        </div>
                        <p class="text-[9px] text-gray-300">Saldo</p>
                        <p class="font-semibold text-[10px] text-gray-100">${formatRupiahWithVisibility(bank.balance)}</p>
                    </div>
                `;
            });
            
            // Set Date to Today
            document.getElementById('input-date').valueAsDate = new Date();
            
            // Initialize category dropdown
            updateCategoryDropdown();
            
            switchTab('input');
        }

        function updateCategoryDropdown() {
            const categorySelect = document.getElementById('input-category');
            const categoryList = categories[currentTxType];
            
            categorySelect.innerHTML = '';
            categoryList.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        }

        function setTxType(type) {
            currentTxType = type;
            const btnExpense = document.getElementById('btn-expense');
            const btnIncome = document.getElementById('btn-income');

            if (type === 'expense') {
                btnExpense.className = "flex-1 py-2 rounded text-xs font-bold bg-gray-800 text-red-400 shadow-sm transition";
                btnIncome.className = "flex-1 py-2 rounded text-xs font-bold text-gray-300 transition";
            } else {
                btnIncome.className = "flex-1 py-2 rounded text-xs font-bold bg-gray-800 text-green-400 shadow-sm transition";
                btnExpense.className = "flex-1 py-2 rounded text-xs font-bold text-gray-300 transition";
            }
            
            // Update category dropdown
            updateCategoryDropdown();
        }

        function switchTab(tabName) {
            ['view-home', 'view-input', 'view-history', 'view-stats', 'view-profile'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const targetView = document.getElementById('view-' + tabName);
            if (targetView) targetView.classList.remove('hidden');

            // Reset Nav Icons
            document.getElementById('icon-home').className = "fa-solid fa-house text-lg mb-1 inactive-tab text-gray-300";
            document.getElementById('text-home').className = "text-[9px] font-medium text-gray-300";
            document.getElementById('icon-history').className = "fa-solid fa-clock-rotate-left text-lg mb-1 inactive-tab text-gray-300";
            document.getElementById('text-history').className = "text-[9px] font-medium text-gray-300";
            document.getElementById('icon-stats').className = "fa-solid fa-chart-simple text-lg mb-1 inactive-tab text-gray-300";
            document.getElementById('text-stats').className = "text-[9px] font-medium text-gray-300";
            document.getElementById('icon-profile').className = "fa-solid fa-user text-lg mb-1 inactive-tab text-gray-300";
            document.getElementById('text-profile').className = "text-[9px] font-medium text-gray-300";

            if (tabName === 'home') {
                document.getElementById('icon-home').className = "fa-solid fa-house text-lg mb-1 active-tab text-blue-400";
                document.getElementById('text-home').className = "text-[9px] font-medium text-blue-400";
            } else if (tabName === 'history') {
                document.getElementById('icon-history').className = "fa-solid fa-clock-rotate-left text-lg mb-1 active-tab text-blue-400";
                document.getElementById('text-history').className = "text-[9px] font-medium text-blue-400";
                // Apply filter if any filter is selected
                const dateFrom = document.getElementById('filter-date-from').value;
                const dateTo = document.getElementById('filter-date-to').value;
                const typeFilter = document.getElementById('filter-type').value;
                if (dateFrom || dateTo || typeFilter) {
                    applyDateFilter();
                }
            } else if (tabName === 'stats') {
                document.getElementById('icon-stats').className = "fa-solid fa-chart-simple text-lg mb-1 active-tab text-blue-400";
                document.getElementById('text-stats').className = "text-[9px] font-medium text-blue-400";
                renderStats();
            } else if (tabName === 'profile') {
                document.getElementById('icon-profile').className = "fa-solid fa-user text-lg mb-1 active-tab text-blue-400";
                document.getElementById('text-profile').className = "text-[9px] font-medium text-blue-400";
                renderProfile();
            }
        }

        // --- STATS FUNCTIONS ---
        function renderStats() {
            // Calculate Monthly Stats first (needed for percentage calculation)
            const currentMonth = moment().format('YYYY-MM');
            let monthlyIncome = 0;
            let monthlyExpense = 0;

            transactions.forEach(tx => {
                if (tx.date.startsWith(currentMonth)) {
                    if (tx.type === 'income') monthlyIncome += tx.nominal;
                    else monthlyExpense += tx.nominal;
                }
            });

            // Calculate Total Balance
            let totalBalance = banks.reduce((acc, bank) => acc + bank.balance, 0);
            const statsBalanceElement = document.getElementById('stats-total-balance');
            const statsBalanceContainer = document.getElementById('stats-total-balance-container');
            const statsBalanceHiddenElement = document.getElementById('stats-total-balance-hidden');
            
            if (statsBalanceElement && statsBalanceContainer && statsBalanceHiddenElement) {
                statsBalanceElement.textContent = formatRupiah(totalBalance);
                
                // Update visibility based on balanceVisible state
                if (balanceVisible) {
                    statsBalanceContainer.classList.remove('hidden');
                    statsBalanceHiddenElement.classList.add('hidden');
                } else {
                    statsBalanceContainer.classList.add('hidden');
                    statsBalanceHiddenElement.classList.remove('hidden');
                }
            }

            const monthlyNet = monthlyIncome - monthlyExpense;
            const total = monthlyIncome + monthlyExpense;
            
            // Calculate percentages
            let incomePercentage = 0;
            let expensePercentage = 0;
            if (total > 0) {
                incomePercentage = Math.round((monthlyIncome / total) * 100);
                expensePercentage = Math.round((monthlyExpense / total) * 100);
            }

            document.getElementById('stats-monthly-income').textContent = formatRupiahWithVisibility(monthlyIncome);
            document.getElementById('stats-monthly-expense').textContent = formatRupiahWithVisibility(monthlyExpense);
            document.getElementById('stats-monthly-net').textContent = formatRupiahWithVisibility(monthlyNet);
            
            // Update percentages
            const incomePercentageElement = document.getElementById('stats-income-percentage');
            const expensePercentageElement = document.getElementById('stats-expense-percentage');
            if (incomePercentageElement) {
                incomePercentageElement.textContent = `(${incomePercentage}%)`;
            }
            if (expensePercentageElement) {
                expensePercentageElement.textContent = `(${expensePercentage}%)`;
            }

            // Render Bank Stats
            const bankStatsContainer = document.getElementById('stats-bank-list');
            bankStatsContainer.innerHTML = '';
            
            banks.forEach(bank => {
                const bankTransactions = transactions.filter(tx => tx.bankId === bank.id);
                const bankIncome = bankTransactions.filter(tx => tx.type === 'income').reduce((sum, tx) => sum + tx.nominal, 0);
                const bankExpense = bankTransactions.filter(tx => tx.type === 'expense').reduce((sum, tx) => sum + tx.nominal, 0);
                
                // Calculate percentage of total balance
                let bankPercentage = 0;
                if (totalBalance > 0) {
                    bankPercentage = Math.round((bank.balance / totalBalance) * 100);
                }
                
                bankStatsContainer.innerHTML += `
                    <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid ${bank.icon} ${bank.color}"></i>
                            <span class="text-[10px] font-semibold text-gray-300">${bank.name}</span>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400">Saldo: <span class="font-bold text-gray-200">${formatRupiahWithVisibility(bank.balance)}</span> <span class="text-[9px] font-semibold text-blue-400">(${bankPercentage}%)</span></p>
                            <p class="text-[9px] text-gray-400">+${formatRupiahWithVisibility(bankIncome)} / -${formatRupiahWithVisibility(bankExpense)}</p>
                        </div>
                    </div>
                `;
            });

            // Render Top 5 Transactions
            const topTransactionsContainer = document.getElementById('stats-top-transactions');
            const sortedTransactions = [...transactions].sort((a, b) => b.nominal - a.nominal).slice(0, 5);
            
            if (sortedTransactions.length === 0) {
                topTransactionsContainer.innerHTML = '<p class="text-[10px] text-gray-400 text-center py-4">Belum ada transaksi</p>';
            } else {
                topTransactionsContainer.innerHTML = sortedTransactions.map((tx, index) => {
                    const bank = banks.find(b => b.id === tx.bankId);
                    const isExpense = tx.type === 'expense';
                    const colorClass = isExpense ? 'text-red-600 text-red-400' : 'text-green-600 text-green-400';
                    
                    return `
                        <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-gray-400 w-4">${index + 1}.</span>
                                <div>
                                    <p class="text-[10px] font-semibold text-gray-300">${tx.note}</p>
                                    <p class="text-[9px] text-gray-400">${bank ? bank.name : 'Unknown'} • ${moment(tx.date).format('D MMM YYYY')}</p>
                                </div>
                            </div>
                            <span class="${colorClass} font-bold text-xs">${formatRupiahWithVisibility(tx.nominal)}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        // --- PROFILE FUNCTIONS ---
        function copyAccountNumber(accountNumber, bankName) {
            if (!accountNumber) {
                showPopup('Peringatan', 'Nomor rekening belum diisi', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(accountNumber).then(() => {
                showPopup('Berhasil', `Nomor rekening ${bankName} berhasil disalin!`, 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = accountNumber;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showPopup('Berhasil', `Nomor rekening ${bankName} berhasil disalin!`, 'success');
            });
        }

        function renderProfile() {
            document.getElementById('profile-total-transactions').textContent = transactions.length;
            document.getElementById('profile-total-banks').textContent = banks.length;
            
            // Render Account Numbers List
            const accountListContainer = document.getElementById('account-numbers-list');
            accountListContainer.innerHTML = '';
            
            const banksWithAccount = banks.filter(bank => bank.accountNumber && bank.accountNumber.trim() !== '');
            
            if (banksWithAccount.length === 0) {
                accountListContainer.innerHTML = '<p class="text-[10px] text-gray-400 text-center py-2">Belum ada nomor rekening tersimpan</p>';
            } else {
                banksWithAccount.forEach(bank => {
                    accountListContainer.innerHTML += `
                        <div class="flex items-center justify-between p-3 bg-gray-800 rounded border border-gray-600">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid ${bank.icon} ${bank.color} text-base"></i>
                                <div>
                                    <p class="text-xs font-semibold text-gray-100">${bank.name}</p>
                                    <p class="text-[10px] text-gray-400 font-mono">${bank.accountNumber}</p>
                                </div>
                            </div>
                            <button onclick="copyAccountNumber('${bank.accountNumber}', '${bank.name}')" class="w-8 h-8 bg-blue-900/30 text-blue-400 rounded flex items-center justify-center active:scale-90 transition" title="Salin Nomor Rekening">
                                <i class="fa-solid fa-copy text-[10px]"></i>
                            </button>
                        </div>
                    `;
                });
            }
            
            // Render Bank Management List
            const bankListContainer = document.getElementById('bank-management-list');
            bankListContainer.innerHTML = '';
            
            if (banks.length === 0) {
                bankListContainer.innerHTML = '<p class="text-[10px] text-gray-400 text-center py-2">Belum ada bank</p>';
            } else {
                banks.forEach(bank => {
                    bankListContainer.innerHTML += `
                        <div class="flex items-center justify-between p-3 bg-gray-800 rounded border border-gray-600">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid ${bank.icon} ${bank.color} text-base"></i>
                                <div>
                                    <p class="text-xs font-semibold text-gray-100">${bank.name}</p>
                                    <p class="text-[10px] text-gray-400">Saldo: ${formatRupiahWithVisibility(bank.balance)}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openEditBankModal('${bank.id}')" class="w-8 h-8 bg-blue-900/30 text-blue-400 rounded flex items-center justify-center active:scale-90 transition" title="Edit">
                                    <i class="fa-solid fa-pencil text-[10px]"></i>
                                </button>
                                <button onclick="deleteBank('${bank.id}')" class="w-8 h-8 bg-red-900/30 text-red-400 rounded flex items-center justify-center active:scale-90 transition" title="Hapus">
                                    <i class="fa-solid fa-trash text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
        }

        function openAddBankModal() {
            document.getElementById('bank-modal-title').textContent = 'Tambah Bank Baru';
            document.getElementById('bank-form').reset();
            document.getElementById('edit-bank-id').value = '';
            document.getElementById('edit-bank-account').value = '';
            document.getElementById('bank-modal').classList.remove('hidden');
        }

        function openEditBankModal(bankId) {
            const bank = banks.find(b => b.id === bankId);
            if (!bank) return;
            
            document.getElementById('bank-modal-title').textContent = 'Edit Bank';
            document.getElementById('edit-bank-id').value = bank.id;
            document.getElementById('edit-bank-name').value = bank.name;
            document.getElementById('edit-bank-account').value = bank.accountNumber || '';
            document.getElementById('edit-bank-color').value = bank.color;
            document.getElementById('edit-bank-icon').value = bank.icon;
            document.getElementById('bank-modal').classList.remove('hidden');
        }

        function closeBankModal() {
            document.getElementById('bank-modal').classList.add('hidden');
            document.getElementById('bank-form').reset();
        }

        async function handleSaveBank(e) {
            e.preventDefault();
            
            const bankId = document.getElementById('edit-bank-id').value;
            const name = document.getElementById('edit-bank-name').value;
            const accountNumber = document.getElementById('edit-bank-account').value;
            const color = document.getElementById('edit-bank-color').value;
            const icon = document.getElementById('edit-bank-icon').value;
            
            if (!name) {
                showPopup('Peringatan', 'Mohon lengkapi semua data!', 'warning');
                return;
            }
            
            if (bankId) {
                // Edit existing bank
                const bankIndex = banks.findIndex(b => b.id === bankId);
                if (bankIndex > -1) {
                    // Update bank (balance remains unchanged)
                    banks[bankIndex].name = name;
                    banks[bankIndex].accountNumber = accountNumber || '';
                    banks[bankIndex].color = color;
                    banks[bankIndex].icon = icon;
                }
            } else {
                // Add new bank (with balance 0)
                const newBank = {
                    id: generateId(),
                    name: name,
                    balance: 0,
                    accountNumber: accountNumber || '',
                    color: color,
                    icon: icon
                };
                banks.push(newBank);
            }
            
            await saveData();
            renderProfile();
            closeBankModal();
            showPopup('Berhasil', bankId ? 'Bank berhasil diupdate!' : 'Bank berhasil ditambahkan!', 'success');
        }

        async function deleteBank(bankId) {
            const bank = banks.find(b => b.id === bankId);
            if (!bank) return;
            
            // Check if bank has transactions
            const bankTransactions = transactions.filter(tx => tx.bankId === bankId);
            const bankBalance = bank.balance;
            
            const confirmMessage = bankTransactions.length > 0 
                ? `Bank "${bank.name}" memiliki ${bankTransactions.length} transaksi dan saldo ${formatRupiah(bankBalance)}. Yakin ingin menghapus? Semua transaksi terkait dan saldo akan dihapus.`
                : `Yakin ingin menghapus bank "${bank.name}" dengan saldo ${formatRupiah(bankBalance)}? Saldo akan dihapus.`;
            
            showConfirm('Konfirmasi Hapus Bank', confirmMessage, async () => {
                // Delete all transactions related to this bank first
                transactions = transactions.filter(tx => tx.bankId !== bankId);
                
                // Remove bank (this will automatically remove its balance from total calculation)
                banks = banks.filter(b => b.id !== bankId);
                
                // Save data immediately
                await saveData();
                
                // Update UI
                renderProfile();
                updateDashboard();
                
                showPopup('Berhasil', `Bank "${bank.name}" dan saldo ${formatRupiah(bankBalance)} berhasil dihapus!`, 'success');
            });
        }

        // Fungsi untuk mengekspor data keuangan saja (banks dan transactions)
        function exportData() {
            const data = {
                banks: banks,
                transactions: transactions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `sakubank-backup-${moment().format('YYYY-MM-DD')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showPopup('Berhasil', 'Data berhasil diekspor!', 'success');
        }

        // --- DATE FILTER FUNCTIONS ---
        function applyDateFilter() {
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const typeFilter = document.getElementById('filter-type').value;
            
            let filtered = [...transactions];
            
            // Filter by type
            if (typeFilter) {
                filtered = filtered.filter(tx => tx.type === typeFilter);
            }
            
            // Filter by date
            if (dateFrom) {
                filtered = filtered.filter(tx => tx.date >= dateFrom);
            }
            
            if (dateTo) {
                filtered = filtered.filter(tx => tx.date <= dateTo);
            }
            
            renderTransactionList(filtered);
        }

        function resetDateFilter() {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-type').value = '';
            renderTransactionList();
        }

        // --- DARK MODE FUNCTIONS ---

        // --- BALANCE VISIBILITY FUNCTIONS ---
        function toggleBalanceVisibility() {
            balanceVisible = !balanceVisible;
            localStorage.setItem('sb_balanceVisible', balanceVisible.toString());
            
            const balanceElement = document.getElementById('dashboard-total-balance');
            const balanceHiddenElement = document.getElementById('balance-hidden');
            const toggleIcon = document.getElementById('balance-toggle-icon');
            
            if (balanceVisible) {
                if (balanceElement) balanceElement.classList.remove('hidden');
                if (balanceHiddenElement) balanceHiddenElement.classList.add('hidden');
                if (toggleIcon) toggleIcon.className = 'fa-solid fa-eye text-xs text-gray-300';
            } else {
                if (balanceElement) balanceElement.classList.add('hidden');
                if (balanceHiddenElement) balanceHiddenElement.classList.remove('hidden');
                if (toggleIcon) toggleIcon.className = 'fa-solid fa-eye-slash text-xs text-gray-300';
            }
            
            // Update all balance displays
            updateDashboard();
            renderTransactionList();
            renderStats();
            renderProfile();
        }

        function initBalanceVisibility() {
            const savedVisibility = localStorage.getItem('sb_balanceVisible');
            balanceVisible = savedVisibility !== 'false'; // Default true
            
            const balanceElement = document.getElementById('dashboard-total-balance');
            const balanceHiddenElement = document.getElementById('balance-hidden');
            const toggleIcon = document.getElementById('balance-toggle-icon');
            
            if (balanceElement && balanceHiddenElement && toggleIcon) {
                if (balanceVisible) {
                    balanceElement.classList.remove('hidden');
                    balanceHiddenElement.classList.add('hidden');
                    toggleIcon.className = 'fa-solid fa-eye text-xs text-gray-300';
                } else {
                    balanceElement.classList.add('hidden');
                    balanceHiddenElement.classList.remove('hidden');
                    toggleIcon.className = 'fa-solid fa-eye-slash text-xs text-gray-300';
                }
            }
        }

        // --- AUTH FUNCTIONS ---
        async function handleGoogleLogin() {
            try {
                if (!window.firebaseSignInWithPopup || !window.firebaseAuth || !window.firebaseGoogleProvider) {
                    console.error('Firebase belum dimuat');
                    showPopup('Error', 'Firebase belum siap. Silakan refresh halaman.', 'error');
                    return;
                }

                const result = await window.firebaseSignInWithPopup(window.firebaseAuth, window.firebaseGoogleProvider);
                const firebaseUser = result.user;
                
                const userData = {
                    uid: firebaseUser.uid,
                    email: firebaseUser.email,
                    name: firebaseUser.displayName,
                    picture: firebaseUser.photoURL,
                    sub: firebaseUser.uid
                };
                
                user = userData;
                localStorage.setItem('sb_user', JSON.stringify(userData));
                
                // Load user data from Firebase
                await loadUserData();
                showMainApp();
            } catch (error) {
                console.error('Error during login:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    // User closed popup, no need to show error
                    return;
                }
                showPopup('Error', 'Terjadi kesalahan saat login: ' + error.message, 'error');
            }
        }

        async function handleLogout() {
            showConfirm('Konfirmasi Keluar', 'Yakin ingin keluar?', async () => {
                try {
                    if (window.firebaseSignOut && window.firebaseAuth) {
                        await window.firebaseSignOut(window.firebaseAuth);
                    }
                } catch (error) {
                    console.error('Error during logout:', error);
                }
                
                user = null;
                localStorage.removeItem('sb_user');
                showLoginPage();
            });
        }

        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        async function showMainApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Load user data from Firebase
            await loadUserData();
            
            // Initialize app after showing
            await cleanupInvalidTransactions();
            initBalanceVisibility();
            updateDashboard();
        }

        async function checkAuth() {
            // Ensure config is loaded first
            await loadConfig();
            
            // Wait for Firebase to be ready
            let firebaseReady = false;
            let checkCount = 0;
            while (!firebaseReady && checkCount < 50) {
                if (window.firebaseOnAuthStateChanged && window.firebaseAuth) {
                    firebaseReady = true;
                } else {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    checkCount++;
                }
            }

            if (window.firebaseOnAuthStateChanged && window.firebaseAuth) {
                // Use Firebase auth state listener
                window.firebaseOnAuthStateChanged(window.firebaseAuth, async (firebaseUser) => {
                    if (firebaseUser) {
                        // User is signed in
                        const userData = {
                            uid: firebaseUser.uid,
                            email: firebaseUser.email,
                            name: firebaseUser.displayName,
                            picture: firebaseUser.photoURL,
                            sub: firebaseUser.uid
                        };
                        user = userData;
                        localStorage.setItem('sb_user', JSON.stringify(userData));
                        await showMainApp();
                    } else {
                        // User is signed out
                        user = null;
                        localStorage.removeItem('sb_user');
                        showLoginPage();
                    }
                });
            } else {
                // Fallback to localStorage check
                if (user) {
                    await showMainApp();
                } else {
                    showLoginPage();
                }
            }
        }

        // --- CLEANUP FUNCTIONS ---
        async function cleanupInvalidTransactions() {
            // Remove transactions that reference deleted banks
            const validBankIds = banks.map(b => b.id);
            const initialCount = transactions.length;
            transactions = transactions.filter(tx => validBankIds.includes(tx.bankId));
            
            if (transactions.length !== initialCount) {
                await saveData();
                console.log(`Cleaned up ${initialCount - transactions.length} invalid transactions`);
            }
        }

        // --- INIT ON LOAD ---
        moment.locale('id');
        checkAuth();

    </script>
</body>
</html>